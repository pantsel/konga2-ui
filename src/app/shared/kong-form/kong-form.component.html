<div class="alert alert-danger" *ngIf="errorMsg">
{{errorMsg}}
</div>
<form (submit)="submit(form.value)" [formGroup]="form" *ngIf="form">
  <div mat-dialog-content [style.max-height]="isModal ? '65vh' : 'inherit'" class="pt-1">

    <!-- CONSUMER FIELD ON PLUGINS -->
    <ng-container *ngIf="isPlugin">
      <mat-form-field class="example-full-width" class="w-100" appearance="outline">
        <mat-label>Consumer</mat-label>
        <input type="text" placeholder="Search by username, custom_id or id"
               matInput formControlName="consumer" [matAutocomplete]="auto">
        <mat-progress-spinner mode="indeterminate"
                              *ngIf="!consumers"
                              matSuffix
                              color="primary" diameter="30"></mat-progress-spinner>
        <mat-autocomplete autoActiveFirstOption #auto="matAutocomplete" [displayWith]="displayFn">
          <mat-option *ngFor="let consumer of filteredConsumers | async" [value]="consumer">
            {{consumer.username || consumer.custom_id || consumer.id}}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </ng-container>

    <mat-form-field [appearance]="field.type === 'boolean' ? 'fill' : 'outline'" class="w-100"
                    [ngClass]="{'decor': field.type === 'boolean'}"
                    *ngFor="let field of fields" [ngSwitch]="field.type">
      <mat-label *ngIf="field.type !== 'boolean'">{{field.label}} <span *ngIf="field.required" class="text-danger">*</span></mat-label>

      <!-- STRING -->
      <ng-container *ngSwitchCase="'string'">
        <!-- PLAIN STRING -->
        <input *ngIf="!field.one_of" matInput formControlName="{{field.name}}">

        <!-- SELECT -->
        <mat-select *ngIf="field.one_of" formControlName="{{field.name}}">
          <mat-option *ngFor="let item of field.one_of" [value]="item">
            {{item}}
          </mat-option>
        </mat-select>
      </ng-container>

      <!-- INTEGER -->
      <ng-container *ngSwitchCase="'integer'">
        <input type="number" matInput formControlName="{{field.name}}">
      </ng-container>

      <!-- NUMBER -->
      <ng-container *ngSwitchCase="'number'">
        <input type="number" matInput formControlName="{{field.name}}">
      </ng-container>


      <!-- BOOLEAN -->
      <ng-container *ngSwitchCase="'boolean'">
        <input matInput placeholder="Input" style="display: none" >
        <mat-slide-toggle
                formControlName="{{field.name}}">
        {{field.label}}
        </mat-slide-toggle>
      </ng-container>

      <!-- ARRAY -->
      <ng-container *ngSwitchCase="'array'">
        <mat-chip-list #chipList>
          <mat-chip *ngFor="let item of form.get(field.name).controls; let i = index;" [selectable]="true"
                    [removable]="true" (removed)="remove(i, field.name)">
            {{item.value}}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <input placeholder="Add.."
                 [matChipInputFor]="chipList"
                 [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                 [matChipInputAddOnBlur]="true"
                 (matChipInputTokenEnd)="add($event, field.name)">
        </mat-chip-list>
      </ng-container>

      <!-- SET -->
      <ng-container *ngSwitchCase="'set'">

        <ng-container *ngIf="field.elements?.one_of">
          <mat-chip-list #chipList>
            <mat-chip *ngFor="let item of form.get(field.name).controls; let i = index;" [selectable]="true"
                      [removable]="true" (removed)="remove(i, field.name)">
              {{item.value}}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
            <input placeholder="Add.."
                   id="{{'input_' + field.name}}"
                   [matChipInputFor]="chipList"
                   [matAutocomplete]="auto"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true">
          </mat-chip-list>
          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onChipAutocompleteOptionSelected($event, field.name)">
            <mat-option *ngFor="let item of filterAvailableOptions(field.elements.one_of, form.get(field.name).value)" [value]="item">
              {{item}}
            </mat-option>
          </mat-autocomplete>
        </ng-container>

        <ng-container *ngIf="!field.elements?.one_of">
          <mat-chip-list #chipList>
            <mat-chip *ngFor="let item of form.get(field.name).controls; let i = index;" [selectable]="true"
                      [removable]="true" (removed)="remove(i, field.name)">
              {{item.value}}
              <mat-icon matChipRemove>cancel</mat-icon>
            </mat-chip>
            <input placeholder="Add.."
                   [matChipInputFor]="chipList"
                   [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                   [matChipInputAddOnBlur]="true"
                   (matChipInputTokenEnd)="add($event, field.name)">
          </mat-chip-list>
        </ng-container>

      </ng-container>

      <!-- DEFAULT -->
      <ng-container *ngSwitchCase="'text'">
        <textarea matInput
                  cdkTextareaAutosize
                  #autosize="cdkTextareaAutosize"
                  formControlName="{{field.name}}"
                  cdkAutosizeMinRows="2"
                  cdkAutosizeMaxRows="5"></textarea>
      </ng-container>

      <!-- DEFAULT -->
      <ng-container *ngSwitchDefault>
        <input matInput formControlName="{{field.name}}">
      </ng-container>



      <mat-hint *ngIf="field.description" [innerHTML]="field.description"></mat-hint>
      <mat-error *ngIf="form.controls[field.name].hasError('required')">
        {{'errors.validation.required' | translate}}
      </mat-error>
      <mat-error *ngIf="form.controls[field.name].hasError(field.name)">
        {{errorFields[field.name]}}
      </mat-error>
    </mat-form-field>

  </div>
  <div mat-dialog-actions>
    <button mat-flat-button color="accent"
            class="btn-large w-100 mt-2 text-center" [disabled]="!form.valid || submitting">
      <mat-progress-spinner mode="indeterminate"
                            *ngIf="submitting"
                            color="primary" diameter="36" class="float-left">
      </mat-progress-spinner>
      {{existingData ? ('konga.save_changes' | translate) : ('konga.submit' | translate)}}
    </button>
  </div>
</form>